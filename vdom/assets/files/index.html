<html>
  <head>
    <script type="text/javascript">
      var socket;

      function registerEventHandler(node, type, id) {
        node.addEventListener(type, function(evt) {
          let eventData = "";
          switch (type) {
            case "change":
              eventData = evt.target.value;
              break;
            case "click":
            case "mousedown":
            case "mouseup":
            case "mouseenter":
            case "mouseleave":
              eventData = evt.buttons.toString();
              break;
          }

          let domEvent = {
            Type: type,
            ElementId: id,
            Data: eventData
          };
          console.log(domEvent);
          socket.send(JSON.stringify(domEvent));
        });
      }

      function createElementRecursive(svgNamespace, element) {
        let node = null;
        if (svgNamespace) {
          node = document.createElementNS(
            "http://www.w3.org/2000/svg",
            element.Name
          );
        } else {
          node = document.createElement(element.Name);
        }

        for (var name in element.Attrs) {
          node.setAttribute(name, element.Attrs[name]);
        }

        for (var i = 0; i < element.Children.length; i++) {
          if (element.Children[i].Type == 2) {
            node.innerText = element.Children[i].Attrs["Text"];
          } else {
            child = createElementRecursive(svgNamespace, element.Children[i]);
            node.appendChild(child);
          }
        }

        for (var i = 0; i < element.EventHandlers.length; i++) {
          registerEventHandler(
            node,
            element.EventHandlers[i].Type,
            element.Attrs["id"]
          );
        }

        return node;
      }

      function applyPatch(patch) {
        child = document.body.firstElementChild;
        if (child && !(child instanceof HTMLScriptElement)) {
          document.body.removeChild(child);
        }

        node = createElementRecursive(patch.SVGNamespace, patch.Element);
        document.body.appendChild(node);
      }

      ws = initWS();

      function initWS() {
        socket = new WebSocket("ws://localhost:8080/client");
        socket.onopen = function() {
          console.log("socket open");
        };
        socket.onmessage = function(e) {
          patch = JSON.parse(e.data);
          console.log(patch);
          applyPatch(patch);
        };
        socket.onclose = function() {
          console.log("socket close");
        };
        return socket;
      }
    </script>
  </head>
  <body></body>
</html>
