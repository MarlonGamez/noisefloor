<html>
  <head>
    <script type="text/javascript">
      var socket;

      function registerEventHandler(node, type, id) {
        node.addEventListener(type, function(evt) {
          let eventData = "";
          switch (type) {
            case "change":
              eventData = evt.target.value;
              break;
            case "click":
            case "mousedown":
            case "mouseup":
            case "mouseenter":
            case "mouseleave":
              eventData = evt.buttons.toString();
              break;
          }

          let domEvent = {
            Type: type,
            ElementId: id,
            Data: eventData
          };
          console.log(domEvent);
          socket.send(JSON.stringify(domEvent));
        });
      }

      function createElementRecursive(svgNamespace, element) {
        let node = null;
        if (svgNamespace) {
          node = document.createElementNS(
            "http://www.w3.org/2000/svg",
            element.Name
          );
        } else {
          node = document.createElement(element.Name);
        }

        for (var name in element.Attrs) {
          node.setAttribute(name, element.Attrs[name]);
        }

        for (var i = 0; i < element.Children.length; i++) {
          if (element.Children[i].Type == 2) {
            node.innerText = element.Children[i].Attrs["Text"];
          } else {
            child = createElementRecursive(svgNamespace, element.Children[i]);
            node.appendChild(child);
          }
        }

        for (var i = 0; i < element.EventHandlers.length; i++) {
          registerEventHandler(
            node,
            element.EventHandlers[i].Type,
            element.Attrs["id"]
          );
        }

        return node;
      }

      function getElementByPath(path) {
        element = document.body.firstElementChild;

        for (var i = 0; i < path.length; i++) {
          element = element.childNodes[path[i]];
        }
        return element;
      }

      function applyPatchList(patchList) {
        const Insert = 0,
          Remove = 1,
          Replace = 2,
          AttrSet = 3,
          AttrRemove = 4;

        for (var i = 0; i < patchList.Patch.length; i++) {
          patch = patchList.Patch[i];
          element = getElementByPath(patch.Path);
          switch (patch.Type) {
            case Replace:
              child = document.body.firstElementChild;
              if (child && !(child instanceof HTMLScriptElement)) {
                document.body.removeChild(child);
              }
              // parent = element.parent;
              // console.log(parent);
              // document.body.removeChild(element);

              node = createElementRecursive(
                patchList.SVGNamespace,
                patch.Element
              );
              document.body.appendChild(node);
              break;
            case AttrSet:
              console.log("setAttr:", patch.Attr.Name, patch.Attr.Value);
              element.setAttribute(patch.Attr.Name, patch.Attr.Value);
              break;
            case AttrRemove:
              element.removeAttribute(patch.Attr.Name);
              break;
          }
        }
      }

      ws = initWS();

      function initWS() {
        socket = new WebSocket("ws://localhost:8080/client");
        socket.onopen = function() {
          console.log("socket open");
        };
        socket.onmessage = function(e) {
          patchList = JSON.parse(e.data);
          console.log(patchList);
          applyPatchList(patchList);
        };
        socket.onclose = function() {
          console.log("socket close");
        };
        return socket;
      }
    </script>
  </head>
  <body></body>
</html>
