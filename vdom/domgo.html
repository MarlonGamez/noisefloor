<html>
    <head>
        <script type="text/javascript">
            // registered event handlers
            let eventHandlers = {};

            function registerEventHandler(node, type, id) {
                node.addEventListener("click", function(evt) { console.log('got click:' + id); });
            }

            function createElementRecursive(element) {
                let node = document.createElement(element.Name);

                for (var i = 0; i < element.Attrs.length; i++) {
                    node.setAttribute(element.Attrs[i].Name, element.Attrs[i].Value);
                }

                for (var i = 0; i < element.Children.length; i++) {
                    if (element.Children[i].Type == 2) {
                        node.innerText = element.Children[i].Attrs[0].Value;
                    }
                    else {
                        child = createElementRecursive(element.Children[i]);
                        node.appendChild(child);
                    }
                }

                for (var i = 0; i < element.EventHandlers.length; i++) {
                    registerEventHandler(node, element.EventHandlers[i].Type);
                    console.log("register event handler");
                }

                return node;
            }

            function applyPatch(patch) {
                node = createElementRecursive(patch.Element);
                document.body.appendChild(node)
            }

            ws = initWS();

            function initWS() {
                var socket = new WebSocket("ws://localhost:8080/client");
                socket.onopen = function() {
                    console.log('socket open');
                };
                socket.onmessage = function (e) {
                    patch = JSON.parse(e.data);
                    console.log(patch);
                    applyPatch(patch);
                }
                socket.onclose = function () {
                    console.log('socket close');
                }
                return socket;
            }
        </script>
        </head>
    <body></body>
</html>
